# MyCraft 意思決定記録

開発中に行った技術的な意思決定を記録する。

---

## テンプレート

### [日付] タイトル

**背景**
なぜこの決定が必要だったか

**選択肢**

1. 選択肢A - Pros / Cons
2. 選択肢B - Pros / Cons

**決定**
何を選んだか、なぜか

**結果**
（後から追記）実際どうだったか

---

## 決定事項

### [2024-XX-XX] 技術スタックの選定

**背景**
Webアプリ + 将来的なモバイル対応が必要

**選択肢**

1. Next.js + Expo + Supabase
   - Pros: TypeScript統一、Supabaseで認証・DB・Storageが一括管理
   - Cons: Supabaseへの依存
2. Next.js + Expo + 自前バックエンド
   - Pros: 柔軟性が高い
   - Cons: 開発コスト大

**決定**
Next.js + Expo + Supabase を採用。MVP開発のスピードを優先。

---

### [2024-XX-XX] State Management

**背景**
クライアント状態とサーバー状態の管理方法

**選択肢**

1. Zustand + Tanstack Query
   - Pros: 軽量、役割分担が明確
2. Redux Toolkit + RTK Query
   - Pros: 大規模対応
   - Cons: ボイラープレートが多い

**決定**
Zustand（グローバル状態） + Tanstack Query（サーバー状態）を採用。

---

### [2026-01-22] ユーザーページURLパターン

**背景**
ユーザーページのURLを `/@{user_id}` にする予定だったが、Next.js App Routerでは `@` プレフィックスがParallel Routes（スロット）用に予約されているため、そのまま使用できない。

**選択肢**

1. `/users/{user_id}` - 標準的なパターン
   - Pros: シンプル、App Routerと競合しない
   - Cons: TwitterライクなURL形式ではない
2. `/%40{user_id}` - URLエンコード使用
   - Pros: 見た目は@を維持
   - Cons: 見た目が悪い、ルーティング複雑
3. Catch-all routeで `/@username` をハンドリング
   - Pros: 希望のURL形式
   - Cons: 実装が複雑、他のルートとの競合リスク

**決定**
`/users/{user_id}` を採用。シンプルさと保守性を優先。UI上では `@user_id` と表示することで、ユーザー体験は維持。

---

### [2026-01-22] Buttonコンポーネントのtype属性デフォルト値

**背景**
プロフィール設定画面で画像をトリミングするためにImageCropperモーダルを開き、「トリミングを適用」ボタンを押すと、親フォーム（ProfileForm）が送信されてしまう問題が発生。これにより、保存ボタンを押す前に「プロフィールを保存しました」というメッセージが表示されてしまった。

**原因**
HTMLの`<button>`要素は、`type`属性を指定しない場合デフォルトで`type="submit"`となる。そのため、フォーム内にあるボタンをクリックすると意図せずフォームが送信される。

**選択肢**

1. Button使用箇所で毎回`type="button"`を明示的に指定
   - Pros: 既存の挙動を変えない
   - Cons: 指定漏れのリスク、ボイラープレート増加
2. Buttonコンポーネントのデフォルトを`type="button"`に変更
   - Pros: 安全なデフォルト、指定漏れがなくなる
   - Cons: フォーム送信ボタンでは`type="submit"`の明示が必要

**決定**
Buttonコンポーネントのデフォルトを`type="button"`に変更。フォーム送信が必要な場合のみ`type="submit"`を明示的に指定する方針とした。これにより、モーダル内のボタンや操作ボタンが意図せずフォームを送信するバグを防止できる。

---

### [2026-01-24] TanStack QueryからSWRへの移行

**背景**
サーバー状態管理にTanStack Queryを使用していたが、SNSアプリの要件を見直した結果、よりシンプルなライブラリで十分と判断。

**選択肢**

1. TanStack Query継続
   - Pros: 機能豊富、細かいキャッシュ制御
   - Cons: バンドルサイズ大、学習コスト高
2. SWRへ移行
   - Pros: 軽量、シンプルなAPI、Vercel製でNext.jsとの相性良好
   - Cons: TanStack Queryほど機能は多くない

**決定**
SWRへ移行。useSWRInfiniteで無限スクロール、mutateでキャッシュ無効化を実装。Zustandと組み合わせてフィードのリフレッシュトリガーを管理。

---

### [2026-01-24] ワールド作成・投稿作成のモーダル化

**背景**
ワールド作成（/worlds/new）と投稿作成（/posts/new）が別ページだったが、UXの一貫性とナビゲーションの簡略化のためモーダル化を検討。

**選択肢**

1. 専用ページを維持
   - Pros: URL共有可能、ブラウザの戻る対応
   - Cons: ページ遷移のオーバーヘッド
2. モーダルに統一
   - Pros: どこからでも素早く作成可能、コンテキスト維持
   - Cons: URL共有不可

**決定**
モーダルに統一。Zustandでモーダル状態を管理（usePostModalStore, useWorldModalStore）。サイドバーやボトムナビから直接開けるように実装。

---

### [2026-01-24] ワールド削除時の投稿カスケード削除

**背景**
ワールド削除時に紐づく投稿のworld_idがSET NULLになっていたが、ワールドと一緒に投稿も削除すべきという要件に変更。

**決定**
マイグレーションで外部キー制約をON DELETE CASCADEに変更。ワールド削除時にStorage内の画像（ワールドアイコン、関連投稿の画像）もクリーンアップするよう実装。

---

### [2026-01-28] SWRキャッシュ無効化パターンの確立

**背景**
いいね、リポスト、フォロー等の操作後に、関連するSWRキャッシュが適切に無効化されず、画面遷移後に古いデータが表示される問題が多発。

**決定**
以下のパターンで統一的にキャッシュ無効化を実装:

- 楽観的更新はZustand storeで管理（dirty flagで保護）
- API成功後にSWR `mutate()` で関連キャッシュを無効化
- キャッシュキーのプレフィックスマッチングで柔軟に無効化

| 操作              | 無効化するキャッシュ                        |
| ----------------- | ------------------------------------------- |
| いいね/リポスト   | `postEngagement`, `postLikes`/`postReposts` |
| フォロー          | `feed` (following), `follow-data`           |
| コメントいいね    | `comments`                                  |
| プロフィール更新  | `profile`, `feed` (アバター更新のため)      |
| ワールド更新      | `world`, `userWorlds`                       |
| ワールド参加/脱退 | `userWorlds`, `worldMembers`                |

---

### [2026-01-28] モーダルのReact Portal化

**背景**
ConfirmDialogがPostCard内でレンダリングされる際、親要素のスタッキングコンテキストに制限され、z-index: 100を設定しても他の要素と重なる問題が発生。

**決定**
`createPortal`を使用して`document.body`直下にモーダルをレンダリング。これによりスタッキングコンテキストから脱出し、z-indexがルートレベルで正しく機能するように。

---

### [2026-01-28] URLリンク化コンポーネント (Linkify)

**背景**
ワールドの参加方法欄にサーバーアドレスやDiscordリンクを記載するユーザーが多いが、プレーンテキストとして表示されクリックできない。

**決定**
`Linkify`コンポーネントを作成。テキスト内のURLを正規表現で検出し、`target="_blank" rel="noopener noreferrer"`付きのリンクに変換。参加方法欄に適用。

---

（以降、開発中に追記）
